<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Harmony Output</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css"
        integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
        integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
        crossorigin="anonymous" />
    <style type="text/css">
        body {
            background-color: #1e1e1e;
            color: #fff;
        }

        #process-window {
            position: fixed;
            bottom: 0%;
            right: 0px;
            left: 0px;
            width: 100%;
            height: 40%;
        }

        #processes {
            position: relative;
            padding-top: 1rem;
            height: calc(100% - 4rem);
        }

        .process-labels {
            height: 100%;
        }

        .process-label-row {
            background-color: #252525;
            height: 3rem;
            width: 100%;
        }

        .process-label-text {
            margin-top: 0;
            margin-bottom: 0;
            padding-left: 1rem;
            line-height: 3rem;
            font-weight: 600;
        }

        .process-bars {
            position: absolute;
            top: 0;
            padding-top: 1rem;
            left: 20.83333%;
            bottom: 0;
            overflow-x: scroll;
            overflow-y: visible;
        }

        .process-bar-row {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-left: 12px;
            padding-right: 1rem;
            width: fit-content;
        }

        .process-bar {
            position: relative;
            background: #323232;
            border-radius: 5px;
            height: 2rem;
        }

        .process-block {
            position: absolute;
            border-radius: 5px;
            height: 2rem;
        }

        .seekbar-button {
            background: #252525;
            color: #fff;
            width: 2.5rem;
            height: 2.5rem;
            margin-top: .25rem;
            margin-bottom: .25rem;
            margin-left: .25rem;
        }

        .seekbar-time {
            margin-top: 0;
            margin-bottom: 0;
            padding-left: 1rem;
            padding-right: 1rem;
            letter-spacing: normal;
            line-height: 3rem;
            font-weight: 600;
        }

        #seekbar-div {
            background-color: #3c3c3c;
            position: relative;
            top: 0%;
            width: 100%;
            height: 3rem;
        }

        #time-slider {
            flex-grow: 1;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        #time-slider:focus {
            outline: none;
        }

        details {
          font: 20px Calibri;
          width: 750px;
        }
        details > summary {
          font-family: "Courier New", Courier, monospace;
          color: white;
          padding: 2px 6px;
          width: 15em;
          /*background-color: lightblue;*/
          border: none;
          /*box-shadow: 3px 3px 4px green;*/
          cursor: pointer;
          transition : color 1s;
        }
        details > p {
          font-family: "Courier New", Courier, monospace;
          color: white;
          padding: 2px 6px;
          width: 15em;
          margin-top: 2px;
          margin-bottom: 2px;
          margin-left: 40px;
        }
        details > * {
          margin-left: 20px;
        }
        details[open] > summary {
          color: #a3a3ff;
        }
    </style>
</head>

<body>
    <div class="pure-g">
        <div class="pure-u-1-2">
            <p id="towa">Data</p>
        </div>
        <div class="pure-u-1-2">
            <div id="issue-box">
                <div style="display: flex">
                    <div style="order: 1; padding-left: 10px; padding-right: 10px; background-color: #252526"><h2 style="color: #ffffff">Issue</h2></div>
                    <div style="order: 5; padding-left: 10px; padding-right: 10px; background-color: #3C3C3C"><h2 id="issue-value" style="color: #F44336">None</h2></div>
                </div>
            </div>
            <div id="all-code">
                <h2 style="background-color: #3c3c3c; padding: 10px">Assembly</h2>
                <div style="height:100px;overflow:auto;">
                    <table id="code-table"></table>
                </div>
            </div>
            <div id="shared-variables" style="height:100%; margin-top: 10px;">
<!--                <h2 style="background-color: #3c3c3c; padding: 10px">Shared Variables</h2>-->
                <div id="shared-var-table" style="overflow-y:auto; font-size: xx-small">
                </div>
            </div>
        </div>
    </div>
    <div id="process-window">
        <div class="pure-g" id="seekbar-div">
            <button class="pure-button seekbar-button" style="margin-left: 1rem" id="button-back">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="pure-button seekbar-button" id="button-play">
                <i class="fas fa-play"></i>
            </button>
            <button class="pure-button seekbar-button" style="margin-right: 1rem;" id="button-forward">
                <i class="fas fa-chevron-right"></i>
            </button>
            <p class="seekbar-time" id="start-time">00:08:32</p>
            <input type="range" min="0" max="100" value="0" id="time-slider">
            <p class="seekbar-time" id="end-time">00:42:03</p>
        </div>
        <div class="pure-g" id="processes">
            <div class="pure-u-5-24 process-labels" id="process-labels"></div>
            <div class="pure-u-19-24 process-bars" id="process-bars">
                <div id="process-slider"
                    style="width: 24px; height: 100%; position: absolute; top: 0; overflow: hidden; z-index: 1;">
                    <svg width="24" height="900" viewBox="0 0 16 600" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g filter="url(#filter0_d)">
                            <line x1="8" y1="602" x2="8.00003" y2="2.00006" stroke="#E0E0E0" stroke-width="2" />
                        </g>
                        <g filter="url(#filter1_d)">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M12 3C12 1.89543 11.1046 1 10 1H6C4.89543 1 4 1.89543 4 3V8.39445C4 8.7893 4.11688 9.17531 4.3359 9.50385L6.33591 12.5039C7.12755 13.6913 8.87247 13.6913 9.66411 12.5038L11.6641 9.50385C11.8831 9.17531 12 8.7893 12 8.39445V3Z"
                                fill="#E0E0E0" />
                        </g>
                        <circle cx="8" cy="8" r="2" fill="#C4C4C4" />
                        <defs>
                            <filter id="filter0_d" x="3" y="6.10352e-05" width="10" height="608"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                                <feOffset dy="2" />
                                <feGaussianBlur stdDeviation="2" />
                                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
                                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape" />
                            </filter>
                            <filter id="filter1_d" x="0" y="1" width="16" height="20.3944" filterUnits="userSpaceOnUse"
                                color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                                <feOffset dy="4" />
                                <feGaussianBlur stdDeviation="2" />
                                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
                                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape" />
                            </filter>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    const BAR_LEN_FACTOR = 5;
    const PLAY_SPEED = 200;
    const COLOR_MAP = ['#c62828', '#AD1457', '#6A1B9A', '#4527A0', '#283593', '#1565C0', '#0277BD', '#00838F',
        '#00695C', '#2E7D32', '#558B2F', '#9E9D24', '#F9A825', '#FF8F00', '#EF6C00', '#D84315', '#4E342E',
        '#424242', '#37474F'
    ];

    let time = 0;
    let maxTime = 0;
    let processLengthPx = 0;

    let harmonyData;

    let timeStartText;
    let timeEndText;
    let timeSlider;
    let playButton;
    let backButton;
    let forwardButton;

    let processLabels;
    let processBars;
    let processSlider;

    let playTimer;
    let playing = false;

    document.addEventListener('DOMContentLoaded', (event) => {
        timeStartText = document.getElementById("start-time");
        timeEndText = document.getElementById("end-time");
        timeSlider = document.getElementById("time-slider");
        playButton = document.getElementById("button-play");
        backButton = document.getElementById("button-back");
        forwardButton = document.getElementById("button-forward");
        processBars = document.getElementById("process-bars");
        processLabels = document.getElementById("process-labels");
        processSlider = document.getElementById("process-slider");
    });

    /**
     * Inserts a row element(s) to the code-table given a macro-step.
     */
    function insertCodeBlock(block) {
      const makeTableCell = (content) => {
        const cell = document.createElement("td");
        if (content != null) {
          cell.innerHTML = content;
        }
        return cell;
      }
      const makeTableRow = (...cells) => {
        const tableRow = document.createElement("tr");
        if (cells != null) {
          cells.forEach(c => {
            tableRow.appendChild(c);
          });
        }
        return tableRow;
      }
      const header = `<span style="color: #C05B5B">${block.filename}<span>: <span style="color: #788585">${block.line_number} ${block.executed_line}</span>`
      const emptyCell = makeTableCell();
      const contentCell = makeTableCell(header);
      const tableRow = makeTableRow(emptyCell, contentCell);
      document.getElementById("code-table").appendChild(tableRow);

      const firstPc = block.first_pc;
      block.code.forEach((c, idx) => {
        const pc = idx + firstPc
        const pcCell = makeTableCell(pc);
        pcCell.setAttribute("style", "color: #788585;")
        const codeCell = makeTableCell(c.code);
        const tableRow = makeTableRow(pcCell, codeCell);
        tableRow.setAttribute("id", `code-pc-${pc}`);
        document.getElementById("code-table").appendChild(tableRow);
      });
    }

    function createHtmlValue(v) {
      const typeofV = typeof v;
      const create = (color, value) => `<span style="color: ${color}">${value}</span>`;
      if (typeofV === "string") {
        return create("#bc6021", `"${v}"`);
      }
      if (typeofV === "boolean" || typeofV === "number") {
        const s = v.toString()
        return create("#24a583", s[0].toUpperCase() + s.substring(1));
      }
      if (v == null) {
        return create("#a01c1c", 'None');
      }
    }
    function makeCollapseable(summary, obj) {
      const collapseable = document.createElement("details");
      const summaryElement = document.createElement("summary");
      summaryElement.innerText = summary;
      collapseable.appendChild(summaryElement);
      Object.entries(obj).forEach(([k, v]) => {
        if (v == null || typeof v !== 'object') {
          const p = document.createElement("p");
          p.innerHTML = `${k}: ${createHtmlValue(v)}`;
          collapseable.appendChild(p);
        } else {
          const subcollapseable = makeCollapseable(`${k}: [object Object]`, v);
          collapseable.appendChild(subcollapseable);
        }
      });
      return collapseable;
    }

    /**
     * Displays the shared variables on the the current state.
     */
    function setSharedVariablesTable(state) {
      const currentSlice = state.currentSlice;
      const collapseable = makeCollapseable("Shared Variables", currentSlice ?? {});
      const table = document.getElementById("shared-var-table")
      table.childNodes.forEach(n => table.removeChild(n));
      collapseable.setAttribute("open", "true");
      table.appendChild(collapseable);
    }

    /**
     * Scrolls the code-table to the current step of the state and highlights that line of code
     * if the step exists.
     */
    function moveAndHighlightCode(state) {
      if (state.currentStep != null) {
        const [pc, _] = state.currentStep;
        const line = document.getElementById("code-pc-" + pc)
        line.scrollIntoView();
      }
    }

    let initWindow = (data) => {
        harmonyData = data;

        // Get all process names in order
        totalDuration = 0;
        let processObjects = new Map();
        if (data.issues != null && data.issues.length > 0) {
          document.getElementById("issue-value").textContent = data.issues[0];
        }

        data.codeBlock.forEach(block => {
          insertCodeBlock(block);
        });

        data.processes.forEach(p => {
            // console.log(p.name);
            // console.log(p.duration);
            if (!processObjects.has(p.pid)) {
                // Label Generation
                let labelContainer = document.createElement("div");
                labelContainer.setAttribute('class', 'process-label-row');
                let label = document.createElement('p');
                label.setAttribute('class', 'process-label-text');
                label.textContent = p.name;
                labelContainer.appendChild(label);
                processLabels.appendChild(labelContainer);
                // Row Generation
                let row = document.createElement("div");
                row.setAttribute('class', 'process-bar-row');
                let bar = document.createElement("div");
                bar.setAttribute('class', "process-bar");
                row.appendChild(bar);
                processObjects.set(p.pid, bar);
                processBars.appendChild(row);
            }

            let processBlock = document.createElement("div");
            processBlock.setAttribute('class', 'process-block');
            processBlock.style.left = `${totalDuration / BAR_LEN_FACTOR}rem`;
            processBlock.style.width = `${p.duration / BAR_LEN_FACTOR}rem`;
            processObjects.get(p.pid).appendChild(processBlock);
            totalDuration += p.duration;
        });

        maxTime = totalDuration;

        let processNum = 0;
        processObjects.forEach((processBar, processId) => {
            processBar.style.width = `${maxTime / BAR_LEN_FACTOR}rem`;
            let blocks = processBar.childNodes;
            blocks.forEach((block) => {
                block.style.background = COLOR_MAP[processNum % COLOR_MAP.length];
            });
            processNum++;
        });
        processLengthPx = convertRemToPixels(maxTime / BAR_LEN_FACTOR);

        timeSlider.max = maxTime;
        timeEndText.innerHTML = timeFormat(maxTime);

        timeSlider.addEventListener('input', (e) => {
            e.preventDefault();
            time = timeSlider.value;
            updateWindow();
        }, false);

        playButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (playing) {
                window.clearInterval(playTimer);
                playButton.firstElementChild.setAttribute('class', 'fas fa-play');
                playing = false;
            } else {
                playTimer = window.setInterval(playExecution, PLAY_SPEED);
                playButton.firstElementChild.setAttribute('class', 'fas fa-pause');
                playing = true;
            }
        }, false);

        forwardButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (time < maxTime) {
                time++;
            }
            updateWindow();
        }, false);

        backButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (time > 0) {
                time--;
            }
            updateWindow();
        }, false);

        // processSlider.addEventListener('drag', (e, drag) => {
        //     e.preventDefault();
        //     console.log(drag.offsetX);
        //     let timeDelta = Math.floor((drag.offsetX / processLengthPx) * maxTime);
        //     time += timeDelta;
        //     updateWindow();
        // }, false);

        updateWindow();
    }

    let playExecution = () => {
        if (time < maxTime) {
            time++;
        } else {
            window.clearInterval(playTimer);
            playButton.firstElementChild.setAttribute('class', 'fas fa-play');
            playing = false;
        }
        updateWindow();
    }

    let updateWindow = () => {
        timeSlider.value = time;
        timeStartText.innerHTML = timeFormat(time);
        processSlider.style.left = `${convertRemToPixels(time / BAR_LEN_FACTOR)}px`;

        const currentState = getStateAtTime();
        moveAndHighlightCode(currentState);
        setSharedVariablesTable(currentState);
    }

    /**
     * Returns the state of the program at the current time shown in the bottom progress bars.
     * @returns {{currentStep: *, currentSlice: null}}
     */
    let getStateAtTime = () => {
        let duration = 0;
        let currentProcess = harmonyData.processes[0];
        for (const p of harmonyData.processes) {
            duration += p.duration;
            // if (duration === maxTime) {
            //     currentProcess = p;
            // }
            if (duration >= time) {
                duration -= p.duration;
                break;
            }
            currentProcess = p;
        }
        let steps = [];
        for (const step of currentProcess.steps) {
            if (step.steps != null) {
                for (let i = step.steps[0]; i <= step.steps[1]; i++) {
                    steps.push([i, null]);
                }
            } else {
                steps.push(step.choose);
            }
        }
        let currentStep = steps[time - duration];
        let currentSlice = null;
        for (const slice of currentProcess.slices) {
            duration += slice.duration;
            if (duration >= time) {
                currentSlice = slice.values;
            }
        }
        return {
            "currentStep": currentStep,
            "currentSlice": currentSlice
        };
    }

    window.addEventListener('message', event => {
      const message = event.data; // The command and JSON data our extension sent
      switch (message.command) {
        case 'load':
          console.log(message.jsonData);
          initWindow(message.jsonData);
          break;
      }
    });

    // Utility Functions

    let timeFormat = (t) => {
      let hours = Math.floor(t / 3600);
      let minutes = Math.floor((t - (hours * 3600)) / 60);
      let seconds = t - (hours * 3600) - (minutes * 60);

      if (hours < 10) {
        hours = "0" + hours;
      }
      if (minutes < 10) {
        minutes = "0" + minutes;
      }
      if (seconds < 10) {
        seconds = "0" + seconds;
      }
      return hours + ':' + minutes + ':' + seconds;
    }

    function convertRemToPixels(rem) {
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }
</script>

</html>
